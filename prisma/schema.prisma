generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===============================================
// ENUM GÊNERO
// ===============================================
enum Gender {
  MASCULINO
  FEMININO
}

// ===============================================
// MEMBRO (Member)
// ===============================================
model Member {
  id        Int       @id @default(autoincrement())
  name      String
  email     String?   @unique
  username  String?   @unique
  password  String?
  phone     String?
  birthDate DateTime?
  gender    Gender?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  profileImageUrl String? 
  // Relacionamentos
  ministries    MemberMinistry[]
  societies     MemberSociety[]
  
  bibleSchoolClassId Int?
  bibleSchoolClass   BibleSchoolClass? @relation(fields: [bibleSchoolClassId], references: [id], onDelete: SetNull)

  council   MemberCouncil?
  diaconate MemberDiaconate?

  attendances         Attendance[]
  teachingAssignments ClassTeacher[] @relation(name: "TeachingAssignments")
}

// ===============================================
// CONSELHO (Council)
// ===============================================
model Council {
  id       Int             @id @default(1)
  members  MemberCouncil[]
  finances Finance[]
  
  documents Document[]
}

// ===============================================
// DIACONIA (Diaconate)
// ===============================================
model Diaconate {
  id      Int               @id @default(1)
  members MemberDiaconate[]

  documents Document[]
}

// ===============================================
// RELAÇÃO MEMBRO ↔ CONSELHO
// ===============================================
model MemberCouncil {
  id        Int @id @default(autoincrement())
  memberId  Int @unique
  councilId Int

  member  Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  council Council @relation(fields: [councilId], references: [id], onDelete: Cascade)
}

// ===============================================
// RELAÇÃO MEMBRO ↔ DIACONIA
// ===============================================
model MemberDiaconate {
  id          Int @id @default(autoincrement())
  memberId    Int @unique
  diaconateId Int

  member    Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  diaconate Diaconate @relation(fields: [diaconateId], references: [id], onDelete: Cascade)
}

// ===============================================
// MINISTÉRIOS (Ministry)
// ===============================================
model Ministry {
  id      Int              @id @default(autoincrement())
  name    String
  members MemberMinistry[]

  documents Document[]
}

model MemberMinistry {
  id         Int @id @default(autoincrement())
  memberId   Int
  ministryId Int

  member   Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  ministry Ministry @relation(fields: [ministryId], references: [id], onDelete: Cascade)

  @@unique([memberId, ministryId])
}

// ===============================================
// SOCIEDADES INTERNAS (InternalSociety)
// ===============================================
model InternalSociety {
  id       Int             @id @default(autoincrement())
  name     String
  members  MemberSociety[]
  finances Finance[]
  events   Event[]
  broadcasts Broadcast[]   // ← adicione esta linha
  documents Document[]
}

model MemberSociety {
  id        Int @id @default(autoincrement())
  memberId  Int
  societyId Int
  cargo     String?   // Presidente, Vice-Presidente, 1º Secretário, 2º Secretário, Tesoureiro, etc.
  joinedAt  DateTime? @default(now())

  member  Member          @relation(fields: [memberId], references: [id], onDelete: Cascade)
  society InternalSociety @relation(fields: [societyId], references: [id], onDelete: Cascade)

  @@unique([memberId, societyId])
}

// ===============================================
// ESCOLA BÍBLICA (BibleSchool)
// ===============================================
model BibleSchool {
  id      Int                @id @default(1)
  classes BibleSchoolClass[] @relation(name: "BibleSchoolClasses")
}

// ===============================================
// CLASSES DA ESCOLA BÍBLICA (BibleSchoolClass)
// ===============================================
model BibleSchoolClass {
  id   Int    @id @default(autoincrement())
  name String

  members  Member[]
  teachers ClassTeacher[]

  bibleSchoolId Int?
  bibleSchool   BibleSchool? @relation(name: "BibleSchoolClasses", fields: [bibleSchoolId], references: [id], onDelete: SetNull)

  documents Document[]
}

// ===============================================
// PROFESSORES DA CLASSE
// ===============================================
model ClassTeacher {
  id       Int @id @default(autoincrement())
  memberId Int
  classId  Int

  member Member           @relation(fields: [memberId], references: [id], name: "TeachingAssignments", onDelete: Cascade)
  class  BibleSchoolClass @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([memberId, classId])
}

// ===============================================
// EVENTOS / PROGRAMAÇÕES
// ===============================================
model Event {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  date        DateTime
  startTime   DateTime?
  endTime     DateTime?
  isPublic    Boolean   @default(false)

  societyId Int?
  society   InternalSociety? @relation(fields: [societyId], references: [id], onDelete: SetNull)

  attendances Attendance[]
}

// ===============================================
// PRESENÇA (Attendance)
// ===============================================
model Attendance {
  id       Int  @id @default(autoincrement())
  memberId Int
  eventId  Int?

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  event  Event? @relation(fields: [eventId], references: [id], onDelete: SetNull)

  isPresent Boolean @default(true)
}

// ===============================================
// AVISOS (Notice)
// ===============================================
model Notice {
  id        Int      @id @default(autoincrement())
  title     String
  message   String
  createdAt DateTime @default(now())
}

// ===============================================
// FINANCEIRO (Finance)
// ===============================================
enum FinanceType {
  ENTRADA
  SAIDA
}

model Finance {
  id          Int         @id @default(autoincrement())
  description String
  type        FinanceType
  value       Float
  date        DateTime    @default(now())
  month       Int
  year        Int

  councilId Int?
  council   Council? @relation(fields: [councilId], references: [id], onDelete: SetNull)

  societyId Int?
  society   InternalSociety? @relation(fields: [societyId], references: [id], onDelete: SetNull)
}

// ===============================================
// DOCUMENTOS (Document)
// Centraliza arquivos de todas as áreas
// ===============================================
model Document {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  fileUrl     String
  createdAt   DateTime @default(now())

  societyId   Int?
  society     InternalSociety? @relation(fields: [societyId], references: [id], onDelete: Cascade)

  councilId   Int?
  council     Council?         @relation(fields: [councilId], references: [id], onDelete: Cascade)

  diaconateId Int?
  diaconate   Diaconate?       @relation(fields: [diaconateId], references: [id], onDelete: Cascade)

  ministryId  Int?
  ministry    Ministry?        @relation(fields: [ministryId], references: [id], onDelete: Cascade)

  bibleSchoolClassId Int?
  bibleSchoolClass   BibleSchoolClass? @relation(fields: [bibleSchoolClassId], references: [id], onDelete: Cascade)
}

model Broadcast {
  id         Int      @id @default(autoincrement())
  title      String
  message    String
  isPublic   Boolean  @default(false)
  createdAt  DateTime @default(now())

  societyId  Int
  society    InternalSociety @relation(fields: [societyId], references: [id], onDelete: Cascade)

  authorName String
  authorRole String

  reactions  BroadcastReaction[]
}

model BroadcastReaction {
  id          Int      @id @default(autoincrement())
  emoji       String
  userId      String
  userName    String
  createdAt   DateTime @default(now())

  broadcastId Int
  broadcast   Broadcast @relation(fields: [broadcastId], references: [id], onDelete: Cascade)

  @@unique([broadcastId, userId, emoji])
}